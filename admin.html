<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Admin Flashcards – Bolognia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#fff; --ink:#111827; --muted:#6b7280; --ok:#16a34a; --err:#dc2626; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f7fb;color:#111827}
    header{background:var(--bg);color:#e5e7eb;padding:16px}
    header h1{margin:0;font-size:1.2rem}
    main{max-width:960px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:.85rem;color:#374151}
    input,textarea,select{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;outline:none}
    input:focus,textarea:focus{border-color:#111827}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{padding:9px 14px;border:none;border-radius:999px;background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#334155}
    button.ok{background:var(--ok)}
    button.err{background:var(--err)}
    small.muted{color:var(--muted)}
    #log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0b1220;color:#e5e7eb;border-radius:8px;padding:12px;max-height:260px;overflow:auto}
    ul#list{margin:8px 0 0 0;padding:0;list-style:none;max-height:280px;overflow:auto}
    ul#list li{padding:6px 8px;border-bottom:1px solid #eee;font-size:.92rem}
    .hint{font-size:.85rem;color:#475569}
    .pill{display:inline-block;padding:2px 8px;background:#eef2ff;border-radius:999px;font-size:.75rem;margin-left:6px}
  </style>
</head>
<body>
  <header>
    <h1>Admin Flashcards Bolognia <span class="pill">Édition JSON + Upload images</span></h1>
  </header>

  <main>
    <!-- 1) Connexion au repo -->
    <section class="card">
      <h2 style="margin-top:0">1) Réglages GitHub</h2>
      <div class="grid-3">
        <div>
          <label>Owner (utilisateur/orga)</label>
          <input id="ghOwner" value="myriamzrrd-prog">
        </div>
        <div>
          <label>Repo</label>
          <input id="ghRepo" value="flashcards-images">
        </div>
        <div>
          <label>Branche</label>
          <input id="ghBranch" value="main">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Token GitHub (fine-grained, <em>Contents: Read &amp; Write</em>)</label>
          <input id="ghToken" type="password" placeholder="ghp_xxx…">
          <small class="muted">Le token n’est jamais stocké, seulement utilisé côté navigateur.</small>
        </div>
        <button id="btnLoad" class="secondary">Charger cards.json</button>
      </div>
    </section>

    <!-- 2) Upload image dans le repo -->
    <section class="card">
      <h2 style="margin-top:0">2) Uploader une image</h2>
      <div class="grid-2">
        <div>
          <label>Fichier image</label>
          <input id="imgFile" type="file" accept="image/*">
        </div>
        <div>
          <label>Chemin cible dans le repo (créé si absent)</label>
          <input id="imgPath" placeholder="ex: images/dermoscopie/141.png">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnUploadImg">Uploader l’image</button>
        <small class="hint">Conseil : range par dossiers (ex. <code>images/dermoscopie/</code>).</small>
      </div>
    </section>

    <!-- 3) Ajouter une carte -->
    <section class="card">
      <h2 style="margin-top:0">3) Ajouter une carte</h2>
      <div class="grid-2">
        <div>
          <label>Catégorie</label>
          <input id="cat" placeholder="ex: Dermoscopie">
        </div>
        <div>
          <label>Chemin image (identique au champ ci-dessus si tu viens d’uploader)</label>
          <input id="imgRel" placeholder="ex: images/dermoscopie/141.png">
        </div>
      </div>
      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Question (recto)</label>
          <textarea id="front" rows="2" placeholder="Que montre cette image ?"></textarea>
        </div>
        <div>
          <label>Réponse (verso)</label>
          <textarea id="back" rows="2" placeholder="Hyperplasie sébacée"></textarea>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Description / légende (optionnelle)</label>
        <textarea id="caption" rows="2" placeholder="Texte complémentaire…"></textarea>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnAdd" class="ok">Ajouter à la liste</button>
        <button id="btnSaveJson">Enregistrer cards.json</button>
        <button id="btnAddAndSave" class="ok">Ajouter + Enregistrer</button>
        <small class="hint">Le JSON est <em>data/cards.json</em> dans le repo.</small>
      </div>
    </section>

    <!-- 4) État / liste -->
    <section class="card">
      <h2 style="margin-top:0">4) État</h2>
      <div class="row">
        <button id="btnRefresh" class="secondary">Rafraîchir depuis GitHub</button>
        <button id="btnClearLocal" class="err">Vider la liste locale</button>
        <small class="hint">Cartes chargées (local) :</small>
      </div>
      <ul id="list"></ul>
      <h3>Journal</h3>
      <pre id="log">Prêt.</pre>
    </section>
  </main>

  <script>
    // ---------- Utils ----------
    const $ = s => document.querySelector(s);
    const api = "https://api.github.com";
    function b64encodeUtf8(str){ return btoa(unescape(encodeURIComponent(str))); }
    function b64decodeUtf8(b64){ return decodeURIComponent(escape(atob(b64))); }

    async function ghGetContent({owner, repo, path, token, ref}){
      const r = await fetch(`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`, {
        headers: token ? { Authorization: `Bearer ${token}` } : {}
      });
      if(r.status === 404) return null;
      if(!r.ok) throw new Error(`GET ${path} -> ${r.status} ${await r.text()}`);
      return await r.json(); // {sha, content(base64), ...}
    }

    async function ghPutText({owner, repo, path, message, text, token, branch, sha}){
      const body = {
        message,
        content: b64encodeUtf8(text),
        branch,
        ...(sha ? { sha } : {})
      };
      const r = await fetch(`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`PUT ${path} -> ${r.status} ${await r.text()}`);
      return await r.json();
    }

    async function ghPutBinary({owner, repo, path, message, base64Content, token, branch, sha}){
      const body = {
        message,
        content: base64Content, // BINAIRE déjà base64
        branch,
        ...(sha ? { sha } : {})
      };
      const r = await fetch(`${api}/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`PUT ${path} -> ${r.status} ${await r.text()}`);
      return await r.json();
    }

    // ---------- État local ----------
    let cards = [];      // tableau local (ce qu'on édite)
    let jsonSha = null;  // sha du fichier data/cards.json (pour màj)

    function repoCfg(){
      return {
        owner:  $('#ghOwner').value.trim(),
        repo:   $('#ghRepo').value.trim(),
        branch: $('#ghBranch').value.trim(),
        token:  $('#ghToken').value.trim()
      };
    }

    function log(msg){
      const el = $('#log');
      el.textContent = (el.textContent ? el.textContent + "\n" : "") + msg;
      el.scrollTop = el.scrollHeight;
    }

    function renderList(){
      const ul = $('#list');
      if(!cards.length){ ul.innerHTML = "<li><em>Aucune carte en mémoire.</em></li>"; return; }
      ul.innerHTML = cards.map((c,i)=>(
        `<li>#${i+1} — <strong>${c.category||'-'}</strong> | ${c.front||''} | <span style="color:#475569">${c.image||''}</span></li>`
      )).join("");
    }

    // ---------- Actions ----------
    async function loadCardsJson(){
      const {owner, repo, branch, token} = repoCfg();
      try{
        const cur = await ghGetContent({owner, repo, path:"data/cards.json", token, ref: branch});
        if(cur && cur.content){
          const text = b64decodeUtf8(cur.content);
          const json = JSON.parse(text);
          cards = Array.isArray(json.cards) ? json.cards : [];
          jsonSha = cur.sha || null;
          log(`Chargé ${cards.length} carte(s) depuis data/cards.json (sha: ${jsonSha?.slice(0,7) || 'new'})`);
        }else{
          cards = [];
          jsonSha = null;
          log("data/cards.json introuvable : il sera créé au prochain enregistrement.");
        }
        renderList();
      }catch(e){
        log("Erreur chargement JSON: " + e.message);
        alert("Erreur chargement JSON (voir journal).");
      }
    }

    async function uploadImage(){
      const {owner, repo, branch, token} = repoCfg();
      const file = $('#imgFile').files[0];
      const path = $('#imgPath').value.trim();
      if(!token) return alert("Token requis");
      if(!file)  return alert("Sélectionne un fichier");
      if(!path)  return alert("Renseigne un chemin cible (ex: images/dermoscopie/141.png)");

      try{
        // lire le fichier en ArrayBuffer -> base64
        const buf = await file.arrayBuffer();
        let binary = '';
        const bytes = new Uint8Array(buf);
        const chunk = 0x8000;
        for(let i=0; i<bytes.length; i+=chunk){
          binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
        }
        const b64 = btoa(binary);

        // récupérer sha si le fichier existe déjà
        let sha = null;
        const existing = await ghGetContent({owner, repo, path, token, ref: branch});
        if(existing?.sha) sha = existing.sha;

        await ghPutBinary({
          owner, repo, path,
          message:`feat(image): ${path}`,
          base64Content: b64,
          token, branch, sha
        });
        log(`Image uploadée → ${path}`);
        // On copie le chemin vers le champ image de la carte pour enchaîner
        if(!$('#imgRel').value) $('#imgRel').value = path;
      }catch(e){
        log("Upload image KO: " + e.message);
        alert("Upload image échoué (voir journal).");
      }
    }

    function addCardLocal(){
      const card = {
        category: $('#cat').value.trim(),
        front:    $('#front').value.trim(),
        back:     $('#back').value.trim(),
        caption:  $('#caption').value.trim(),
        image:    $('#imgRel').value.trim()
      };
      if(!card.category || !card.front || !card.back){
        alert("Catégorie, question et réponse sont requis.");
        return;
      }
      cards.push(card);
      renderList();
      log("Carte ajoutée en mémoire.");
    }

    async function saveJson(){
      const {owner, repo, branch, token} = repoCfg();
      if(!token) return alert("Token requis");
      try{
        const contentStr = JSON.stringify({ cards }, null, 2);
        const res = await ghPutText({
          owner, repo, path:"data/cards.json",
          message:"chore: update cards.json via admin",
          text: contentStr,
          token, branch, sha: jsonSha || undefined
        });
        jsonSha = res.content?.sha || null;
        log(`cards.json enregistré (${cards.length} cartes) — sha: ${jsonSha?.slice(0,7) || 'new'}`);
        alert("JSON enregistré ✅");
      }catch(e){
        log("Enregistrement JSON KO: " + e.message);
        alert("Échec enregistrement (voir journal).");
      }
    }

    // ---------- Wiring UI ----------
    $('#btnLoad').addEventListener('click', loadCardsJson);
    $('#btnUploadImg').addEventListener('click', uploadImage);
    $('#btnAdd').addEventListener('click', addCardLocal);
    $('#btnSaveJson').addEventListener('click', saveJson);
    $('#btnAddAndSave').addEventListener('click', async ()=>{
      addCardLocal(); await saveJson();
    });
    $('#btnRefresh').addEventListener('click', loadCardsJson);
    $('#btnClearLocal').addEventListener('click', ()=>{
      if(confirm("Vider la liste locale (non poussé) ?")){
        cards = []; renderList(); log("Liste locale vidée.");
      }
    });

    // Pré-remplir automatiquement imgRel quand on tape dans imgPath
    $('#imgPath').addEventListener('input', e=>{
      if(!$('#imgRel').value) $('#imgRel').value = e.target.value.trim();
    });

    // Auto-focus token au chargement
    window.addEventListener('DOMContentLoaded', ()=> $('#ghToken').focus());
  </script>
</body>
</html>

