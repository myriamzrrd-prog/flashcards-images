<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Flashcards Bolognia</title>
  <style>
    :root { --bg:#f6f7fb; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --brand:#111827; --ok:#16a34a; --warn:#dc2626; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--ink); }
    header { position:sticky; top:0; z-index:10; background:white; border-bottom:1px solid var(--line); }
    .wrap { max-width:1100px; margin:0 auto; padding:16px; }
    h1 { font-size:1.4rem; margin:0 0 4px; }
    .sub { color:var(--muted); font-size:.9rem; }

    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .toolbar input[type="text"]{ padding:8px 10px; border:1px solid var(--line); border-radius:999px; min-width:240px; }
    .toolbar select{ padding:8px 10px; border:1px solid var(--line); border-radius:12px; }
    button{ padding:8px 12px; border:none; border-radius:12px; background:var(--brand); color:white; cursor:pointer; }
    button.secondary{ background:white; color:var(--ink); border:1px solid var(--line); }
    button.ok{ background:var(--ok); }
    button.warn{ background:var(--warn); }
    .small{ font-size:.85rem; color:var(--muted); }

    main { padding:16px; }
    .panel { background:white; border:1px solid var(--line); border-radius:16px; padding:12px; }

    table { width:100%; border-collapse: collapse; }
    thead th { position:sticky; top:0; background:#fafafa; border-bottom:1px solid var(--line); padding:8px; text-align:left; font-size:.9rem; }
    tbody td { border-bottom:1px solid var(--line); padding:8px; vertical-align: top; }
    tbody tr:hover { background:#fafafa; }

    input[type="text"].cell, textarea.cell { width:100%; font: inherit; border:1px solid var(--line); border-radius:8px; padding:6px 8px; }
    textarea.cell { resize: vertical; min-height: 52px; }
    .actions { display:flex; gap:6px; }

    .grid2 { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .right { text-align:right; }
    .mt8{ margin-top:8px; }
    .mt12{ margin-top:12px; }
    .mt16{ margin-top:16px; }

    .toast { position:fixed; right:16px; bottom:16px; background:#111827; color:white; padding:10px 12px; border-radius:12px; opacity:0; transform: translateY(6px); transition: all .2s ease; }
    .toast.show { opacity:1; transform: translateY(0); }

    @media (max-width:900px){ thead .hide-sm { display:none; } tbody .hide-sm { display:none; } }
  </style>
</head>
<body>
  <!--
    Cette page admin Ã©crit dans localStorage :
      - CUSTOM_CARDS_KEY   = "FLASHCARDS_CARDS_JSON"  â†’ { cards: [ {category,front,back,image,caption} ] }
      - CUSTOM_VERSION_KEY = "FLASHCARDS_VERSION"     â†’ bump (Date.now()) pour dire Ã  index.html de recharger
  -->

  <header>
    <div class="wrap">
      <h1>Admin Flashcards</h1>
      <div class="sub" id="meta">Chargementâ€¦</div>
      <div class="toolbar">
        <input type="text" id="q" placeholder="Rechercher (dans toutes les colonnes)" />
        <select id="catFilter"><option value="">Toutes les catÃ©gories</option></select>
        <button id="add">+ Ajouter une carte</button>
        <button id="save" class="ok">ðŸ’¾ Sauvegarder</button>
        <button id="export" class="secondary">â¬‡ï¸Ž Export JSON</button>
        <label class="secondary" style="display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--line); border-radius:12px; cursor:pointer;">
          â¬†ï¸Ž Import JSON <input id="import" type="file" accept="application/json" style="display:none;" />
        </label>
        <a href="index.html" class="small" target="_blank" style="margin-left:auto; text-decoration:none;">â–¶ï¸Ž Ouvrir l'interface (index.html)</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <div class="grid2">
        <div class="small">Astuce : l'image peut Ãªtre un nom de fichier (ex: <code>105.png</code>) ou une URL complÃ¨te (<code>https://â€¦</code>).<br/>CatÃ©gorie, Question (front) et RÃ©ponse (back) sont les plus importants.</div>
        <div class="right small">Double-clique une cellule pour tout sÃ©lectionner âŒ˜/Ctrl+C</div>
      </div>
      <div class="mt12" style="overflow:auto; max-height: 70vh;">
        <table>
          <thead>
            <tr>
              <th style="width:180px;">CatÃ©gorie</th>
              <th>Question (front)</th>
              <th>RÃ©ponse (back)</th>
              <th class="hide-sm" style="width:220px;">Image</th>
              <th class="hide-sm" style="width:240px;">LÃ©gende</th>
              <th style="width:170px;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="mt8 small" id="count"></div>
    </div>
  </main>

  <div id="toast" class="toast">SauvegardÃ© âœ”ï¸Ž</div>

  <script>
    // --- ClÃ©s partagÃ©es avec index.html ---
    const CUSTOM_CARDS_KEY   = "FLASHCARDS_CARDS_JSON";
    const CUSTOM_VERSION_KEY = "FLASHCARDS_VERSION";

    // --- Ã‰tat ---
    let cards = [];     // jeu en Ã©dition
    let filteredIdx = [];// indices visibles (aprÃ¨s filtre + recherche)

    // --- Helpers UI ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const toast = (msg) => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); };

    function readLocalCards(){
      try{
        const raw = localStorage.getItem(CUSTOM_CARDS_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return parsed; // tolÃ¨re ancien format
        if(parsed && Array.isArray(parsed.cards)) return parsed.cards;
      }catch(e){ console.warn('JSON invalide dans localStorage', e); }
      return [];
    }

    function writeLocalCards(list){
      try{
        localStorage.setItem(CUSTOM_CARDS_KEY, JSON.stringify({ cards: list }));
        localStorage.setItem(CUSTOM_VERSION_KEY, String(Date.now()));
      }catch(e){ alert('Erreur en sauvegarde (quota ?): '+ e.message); }
    }

    function uniqueCategories(list){
      return Array.from(new Set(list.map(c=> (c.category||'').trim()).filter(Boolean))).sort((a,b)=> a.localeCompare(b));
    }

    function updateMeta(){
      const total = cards.length;
      const cats = uniqueCategories(cards).length;
      $('#meta').textContent = `${total} carte(s) â€¢ ${cats} catÃ©gorie(s)`;
      $('#count').textContent = `${filteredIdx.length} affichÃ©e(s)`;
    }

    function buildFilters(){
      const sel = $('#catFilter');
      const current = sel.value;
      const opts = [''].concat(uniqueCategories(cards));
      sel.innerHTML = opts.map(v=>`<option value="${v.replaceAll('"','&quot;')}">${v || 'Toutes les catÃ©gories'}</option>`).join('');
      // restaure valeur si possible
      if(opts.includes(current)) sel.value = current;
    }

    function passesSearch(card, q){
      if(!q) return true;
      const hay = `${card.category||''} ${card.front||''} ${card.back||''} ${card.caption||''} ${card.image||''}`.toLowerCase();
      return q.split(/\s+/).filter(Boolean).every(w=> hay.includes(w));
    }

    function recomputeFiltered(){
      const q = $('#q').value.trim().toLowerCase();
      const cat = $('#catFilter').value;
      filteredIdx = [];
      cards.forEach((c, i)=>{
        const okCat = !cat || (c.category||'') === cat;
        const okQ = passesSearch(c, q);
        if(okCat && okQ) filteredIdx.push(i);
      });
    }

    function render(){
      recomputeFiltered();
      buildFilters();
      updateMeta();
      const tbody = $('#rows');
      if(!filteredIdx.length){ tbody.innerHTML = '<tr><td colspan="6" class="small" style="text-align:center; padding:16px; color:var(--muted);">Aucune carte Ã  afficher.</td></tr>'; return; }
      const rows = filteredIdx.map(i=>{
        const c = cards[i];
        const esc = (s)=> (s??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
        return `
          <tr data-i="${i}">
            <td><input type="text" class="cell f-cat" value="${esc(c.category)}" placeholder="CatÃ©gorie" /></td>
            <td><textarea class="cell f-front" placeholder="Question">${esc(c.front)}</textarea></td>
            <td><textarea class="cell f-back" placeholder="RÃ©ponse">${esc(c.back)}</textarea></td>
            <td class="hide-sm"><input type="text" class="cell f-image" value="${esc(c.image)}" placeholder="105.png ou https://â€¦" /></td>
            <td class="hide-sm"><textarea class="cell f-caption" placeholder="LÃ©gende">${esc(c.caption)}</textarea></td>
            <td>
              <div class="actions">
                <button class="secondary btn-dup">Dupliquer</button>
                <button class="warn btn-del">Supprimer</button>
              </div>
            </td>
          </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }

    // --- Ã‰couteurs ---
    $('#q').addEventListener('input', render);
    $('#catFilter').addEventListener('change', render);

    $('#add').addEventListener('click', ()=>{
      cards.push({ category:'', front:'', back:'', image:'', caption:'' });
      render();
    });

    $('#save').addEventListener('click', ()=>{
      writeLocalCards(cards);
      toast('SauvegardÃ© et signal envoyÃ© Ã  index.html');
    });

    $('#export').addEventListener('click', ()=>{
      const blob = new Blob([ JSON.stringify({ cards }, null, 2) ], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'flashcards-cards.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#import').addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try{
          const data = JSON.parse(fr.result);
          let list = Array.isArray(data) ? data : (data && Array.isArray(data.cards) ? data.cards : null);
          if(!list) throw new Error('Format attendu: {"cards": [...] } ou [ ... ]');
          // normalise objets
          cards = list.map(c => ({
            category: c.category || '',
            front: c.front || '',
            back: c.back || '',
            image: c.image || '',
            caption: c.caption || ''
          }));
          render();
          toast('Import OK (pense Ã  sauvegarder)');
        }catch(err){
          alert('Import impossible : '+ err.message);
        }
        e.target.value = '';
      };
      fr.readAsText(file);
    });

    // dÃ©lÃ©gation pour les lignes
    $('#rows').addEventListener('input', (e)=>{
      const tr = e.target.closest('tr[data-i]');
      if(!tr) return;
      const i = Number(tr.dataset.i);
      const c = cards[i];
      if(!c) return;
      if(e.target.classList.contains('f-cat')) c.category = e.target.value;
      if(e.target.classList.contains('f-front')) c.front = e.target.value;
      if(e.target.classList.contains('f-back')) c.back = e.target.value;
      if(e.target.classList.contains('f-image')) c.image = e.target.value;
      if(e.target.classList.contains('f-caption')) c.caption = e.target.value;
      // si la catÃ©gorie change, actualiser les filtres
      if(e.target.classList.contains('f-cat')) buildFilters();
    });

    $('#rows').addEventListener('click', (e)=>{
      const tr = e.target.closest('tr[data-i]');
      if(!tr) return;
      const i = Number(tr.dataset.i);
      if(e.target.classList.contains('btn-del')){
        if(confirm('Supprimer cette carte ?')){
          cards.splice(i,1);
          render();
        }
      }
      if(e.target.classList.contains('btn-dup')){
        const copy = JSON.parse(JSON.stringify(cards[i]));
        cards.splice(i+1, 0, copy);
        render();
      }
    });

    // sÃ©lectionner vite le contenu au double-clic
    document.addEventListener('dblclick', (e)=>{
      if(e.target.matches('input.cell, textarea.cell')){
        e.target.select();
      }
    });

    // --- Init ---
    (function init(){
      cards = readLocalCards();
      render();
    })();
  </script>
</body>
</html>

