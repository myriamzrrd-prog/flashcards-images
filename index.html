<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Flashcards Bolognia - Myriam ZERROUDI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: #f5f5f5;
    }

    /* ======================
       ÉCRAN DE CODE / VERROU
       ====================== */
    .lock-screen {
      position: fixed;
      inset: 0;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
    }

    .lock-card {
      background: white;
      border-radius: 16px;
      padding: 24px 20px;
      max-width: 360px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .lock-card h1 {
      font-size: 1.4rem;
      margin-bottom: 4px;
      color: #111827;
    }

    .lock-card p {
      font-size: 0.9rem;
      margin: 4px 0 12px;
      color: #4b5563;
    }

    .lock-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      margin-bottom: 10px;
      outline: none;
    }

    .lock-input:focus {
      border-color: #111827;
    }

    .lock-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .lock-btn:hover {
      background: #020617;
    }

    .lock-error {
      margin-top: 8px;
      color: #b91c1c;
      font-size: 0.85rem;
    }

    /* ======================
       LAYOUT GLOBAL
       ====================== */
    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* Colonne de gauche (catégories) */
    .sidebar {
      width: 260px;
      background: #111827;
      color: #e5e7eb;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .sidebar h2 {
      font-size: 1rem;
      margin: 0 0 8px;
    }

    .category-list {
      margin-top: 8px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 4px;
    }

    .category-item {
      text-align: left;
      padding: 6px 8px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: inherit;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .category-item:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .category-item.active {
      background: #f9fafb;
      color: #111827;
      font-weight: 600;
    }

    /* Erreurs (rouge clair) */
    .category-item[data-category="Erreurs"] {
      background: #fee2e2;
      color: #991b1b;
    }
    .category-item[data-category="Erreurs"]:hover { background: #fecaca; }
    .category-item[data-category="Erreurs"].active {
      background: #fecaca; color: #7f1d1d;
    }

    /* Aléatoire (rose pastel) */
    .category-item[data-category="Aléatoire"] {
      background: #fce7f3; color: #9d174d;
    }
    .category-item[data-category="Aléatoire"]:hover { background: #fbcfe8; }
    .category-item[data-category="Aléatoire"].active {
      background: #fbcfe8; color: #831843; font-weight: 600;
    }

    /* Dermoscopie (vert clair) */
    .category-item[data-category="Dermoscopie"] {
      background: #dcfce7; color: #166534;
    }
    .category-item[data-category="Dermoscopie"]:hover { background: #bbf7d0; }
    .category-item[data-category="Dermoscopie"].active {
      background: #bbf7d0; color: #14532d; font-weight: 600;
    }

    /* ======================
       PARTIE DROITE
       ====================== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 24px;
      align-items: center;
    }

    .top-bar {
      width: 100%;
      max-width: 900px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .title {
      font-size: 1.8rem;
      font-weight: 600;
      margin: 0;
      color: #111827;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    .subtitle-name { font-size: 0.9rem; font-weight: 400; opacity: 0.75; }

    .header-search {
      display: flex; align-items: center; gap: 8px; flex-wrap: nowrap;
    }
    .header-search input {
      padding: 8px 12px; border-radius: 999px; border: 1px solid #d1d5db;
      font-size: 1rem; min-width: 240px; max-width: 320px; outline: none;
    }
    .header-search input::placeholder { color: #9ca3af; }
    .header-search button {
      padding: 8px 12px; border-radius: 999px; border: none; background: #111827;
      color: white; font-size: 0.9rem; cursor: pointer; white-space: nowrap;
    }
    .header-search button:hover { background: #020617; }

    /* ======================
       MODE RÉVISION
       ====================== */
    #reviewMode {
      width: 100%; max-width: 900px; display: flex; flex-direction: column;
      gap: 8px; align-items: stretch;
    }

    .review-layout { display: flex; gap: 16px; align-items: stretch; }
    .review-left { flex: 1; display: flex; flex-direction: column; gap: 8px; }

    .card {
      position: relative; width: 100%; max-width: 600px; margin: 0 auto;
      background: white; border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding: 24px; text-align: center; font-size: 1.05rem; cursor: pointer;
      user-select: none; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }

    .card-text {
      margin-bottom: 12px; font-size: 1.08rem; text-align: left; max-width: 90%;
    }

    .caption {
      margin-top: 4px; margin-bottom: 12px; font-size: 0.9rem; color: #6b7280;
      text-align: left; max-width: 90%;
    }

    #card img {
      max-height: 55vh; width: 95%; max-width: 100%; height: auto; display: block;
      margin: 0 auto 12px; border-radius: 12px; object-fit: contain;
    }

    .controls-column {
      display: flex; flex-direction: column; gap: 8px; align-items: stretch; justify-content: flex-start;
    }
    .controls-column button { width: 140px; }

    button {
      padding: 8px 14px; border-radius: 999px; border: none; cursor: pointer;
      background: #111827; color: white; font-size: 0.9rem;
    }
    button:disabled { opacity: 0.4; cursor: default; }

    .btn-know { background: #16a34a; }
    .btn-error { background: #dc2626; }
    .btn-error.active-error { box-shadow: 0 0 0 2px #fecaca; }

    .info { margin-top: 4px; font-size: 0.85rem; color: #6b7280; text-align: center; }

    /* ======================
       MODE RECHERCHE
       ====================== */
    .search-mode { width: 100%; max-width: 900px; }
    .search-mode-header {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between;
      margin-top: 12px; margin-bottom: 12px;
    }
    .search-mode-header h2 { font-size: 1.1rem; margin: 0; }
    .search-query-label { font-size: 0.9rem; color: #4b5563; margin: 0; }
    #exitSearchBtn {
      font-size: 0.8rem; padding: 6px 10px; border-radius: 999px; border: none;
      background: #111827; color: white; cursor: pointer; white-space: nowrap;
    }

    .search-results {
      display: flex; flex-direction: column; gap: 12px; max-height: 60vh; overflow-y: auto; padding-right: 4px;
    }
    .search-card {
      background: white; border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      text-align: left;
    }
    .search-card-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 6px; color: #6b7280; }
    .search-card-index { font-weight: 500; }
    .search-card-category { font-weight: 500; }
    .search-card img { width: 40%; max-width: 260px; height: auto; display: block; margin-bottom: 8px; border-radius: 8px; }
    .search-card-front, .search-card-back, .search-card-caption { font-size: 0.9rem; margin-bottom: 4px; }
    .search-card-jump {
      margin-top: 6px; font-size: 0.8rem; padding: 6px 10px; border-radius: 999px; border: none;
      background: #111827; color: white; cursor: pointer;
    }

    /* ======================
       RESPONSIVE
       ====================== */
    @media (max-width: 900px) {
      .review-layout { flex-direction: column; }
      .controls-column { flex-direction: row; justify-content: center; flex-wrap: wrap; }
      .controls-column button { width: auto; }
    }
    @media (max-width: 768px) {
      .layout { flex-direction: column; }
      .sidebar { width: 100%; height: auto; max-height: 260px; }
      .category-item { font-size: 0.8rem; padding: 4px 6px; }
      .card { width: 100%; }
      #card img { width: 90%; }
      .search-card img { width: 60%; }
      .top-bar { align-items: flex-start; }
    }
  </style>
</head>
<body>
  <!-- ÉCRAN DE CODE -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <h1>Flashcards Bolognia</h1>
      <p>Accès réservé – entre le code :</p>
      <input id="codeInput" type="password" class="lock-input" placeholder="Code d’accès">
      <button id="codeBtn" class="lock-btn">Valider</button>
      <p id="codeError" class="lock-error" style="display:none;">Code incorrect</p>
    </div>
  </div>

  <!-- APP PRINCIPALE -->
  <div id="app" style="display:none;">
    <div class="layout">
      <!-- Colonne gauche : catégories -->
      <aside class="sidebar">
        <h2>Catégories</h2>
        <div class="category-list">
          <button class="category-item" data-category="Erreurs">Erreurs</button>
          <button class="category-item active" data-category="Aléatoire">Aléatoire</button>
          <button class="category-item" data-category="Dermoscopie">Dermoscopie</button>

          <button class="category-item" data-category="Prurit et dysesthésies">Prurit et dysesthésies</button>
          <button class="category-item" data-category="Affections psychocutanées">Affections psychocutanées</button>
          <button class="category-item" data-category="Psoriasis">Psoriasis</button>
          <button class="category-item" data-category="Autres affections papulosquameuses">Autres affections papulosquameuses</button>
          <button class="category-item" data-category="Erythrodermie">Erythrodermie</button>
          <button class="category-item" data-category="Lichen plan et dermatoses lichénoïdes">Lichen plan et dermatoses lichénoïdes</button>
          <button class="category-item" data-category="Dermatite atopique">Dermatite atopique</button>
          <button class="category-item" data-category="Autres éruptions eczémateuses">Autres éruptions eczémateuses</button>
          <button class="category-item" data-category="Dermatites de contact / pro / aux plantes">Dermatites de contact / pro / aux plantes</button>
          <button class="category-item" data-category="Approche clinique des dermatoses régionales">Approche clinique des dermatoses régionales</button>
          <button class="category-item" data-category="Urticaire et angio-oedème">Urticaire et angio-oedème</button>
          <button class="category-item" data-category="Erythèmes figurés">Erythèmes figurés</button>
          <button class="category-item" data-category="Erythème polymorphe, SJS et NET">Erythème polymorphe, SJS et NET</button>
          <button class="category-item" data-category="Réactions aux médicaments">Réactions aux médicaments</button>
          <button class="category-item" data-category="Purpura et affections dues à une occlusion microvasculaire">Purpura et affections dues à une occlusion microvasculaire</button>
          <button class="category-item" data-category="Vascularites">Vascularites</button>
          <button class="category-item" data-category="Dermatoses éosinophiliques">Dermatoses éosinophiliques</button>
          <button class="category-item" data-category="Dermatoses neutrophiliques">Dermatoses neutrophiliques</button>
          <button class="category-item" data-category="Dermatoses de la grossesse">Dermatoses de la grossesse</button>
          <button class="category-item" data-category="Pemphigus">Pemphigus</button>
          <button class="category-item" data-category="Pemphigoïde et épidermolyse bulleuse acquise">Pemphigoïde et épidermolyse bulleuse acquise</button>

          <button class="category-item" data-category="Dermatite herpétiforme et dermatose bulleuse à IgA linéaires">Dermatite herpétiforme et dermatose bulleuse à IgA linéaires</button>
          <button class="category-item" data-category="Épidermolyses bulleuses">Épidermolyses bulleuses</button>
          <button class="category-item" data-category="Autres maladies vésiculobulleuses">Autres maladies vésiculobulleuses</button>
          <button class="category-item" data-category="Affections vésiculopustuleuses et érosives chez les nouveau-nés et nourrissons">Affections vésiculopustuleuses et érosives chez les nouveau-nés et nourrissons</button>

          <button class="category-item" data-category="Acné vulgaire">Acné vulgaire</button>
          <button class="category-item" data-category="Rosacée et dermatite périorificielle">Rosacée et dermatite périorificielle</button>
          <button class="category-item" data-category="Folliculites">Folliculites</button>
          <button class="category-item" data-category="Affections des glandes eccrines et apocrines">Affections des glandes eccrines et apocrines</button>

          <button class="category-item" data-category="Lupus érythémateux">Lupus érythémateux</button>
          <button class="category-item" data-category="Dermatomyosite">Dermatomyosite</button>
          <button class="category-item" data-category="Sclérodermie systémique et affections sclérodermoïdes">Sclérodermie systémique et affections sclérodermoïdes</button>
          <button class="category-item" data-category="Morphée et lichen scléreux">Morphée et lichen scléreux</button>
          <button class="category-item" data-category="Autres maladies rhumatologiques et maladies auto-inflammatoires">Autres maladies rhumatologiques et maladies auto-inflammatoires</button>

          <button class="category-item" data-category="Mucinoses">Mucinoses</button>
          <button class="category-item" data-category="Amylose">Amylose</button>
          <button class="category-item" data-category="Maladies de surcharge">Maladies de surcharge</button>
          <button class="category-item" data-category="Porphyries">Porphyries</button>
          <button class="category-item" data-category="Calcinose cutanée et ostéome cutané">Calcinose cutanée et ostéome cutané</button>
          <button class="category-item" data-category="Désordres nutritionnels">Désordres nutritionnels</button>
          <button class="category-item" data-category="Maladie du greffon contre l'hôte">Maladie du greffon contre l'hôte</button>
          <button class="category-item" data-category="Manifestations cutanées des maladies systémiques">Manifestations cutanées des maladies systémiques</button>

          <button class="category-item" data-category="Ichtyoses et érythrokératodermies">Ichtyoses et érythrokératodermies</button>
          <button class="category-item" data-category="Kératodermies">Kératodermies</button>
          <button class="category-item" data-category="Maladie de Darier et maladie de Hailey-Hailey">Maladie de Darier et maladie de Hailey-Hailey</button>

          <button class="category-item" data-category="Déficits immunitaires primitifs">Déficits immunitaires primitifs</button>
          <button class="category-item" data-category="Neurofibromatose et sclérose tubéreuse de Bourneville">Neurofibromatose et sclérose tubéreuse de Bourneville</button>
          <button class="category-item" data-category="Mosaïques cutanées">Mosaïques cutanées</button>
          <button class="category-item" data-category="Autres génodermatoses">Autres génodermatoses</button>
          <button class="category-item" data-category="Anomalies du développement">Anomalies du développement</button>

          <button class="category-item" data-category="Vitiligo et autres affections avec hypopigmentation">Vitiligo et autres affections avec hypopigmentation</button>
          <button class="category-item" data-category="Maladies avec hyperpigmentation">Maladies avec hyperpigmentation</button>
          <button class="category-item" data-category="Alopécies">Alopécies</button>
          <button class="category-item" data-category="Hypertrichose et hirsutisme">Hypertrichose et hirsutisme</button>
          <button class="category-item" data-category="Affections des ongles">Affections des ongles</button>
          <button class="category-item" data-category="Affections orales">Affections orales</button>
          <button class="category-item" data-category="Maladies anogénitales">Maladies anogénitales</button>

          <button class="category-item" data-category="Infections à mycobactéries">Infections à mycobactéries</button>
          <button class="category-item" data-category="Rickettsioses">Rickettsioses</button>
          <button class="category-item" data-category="Maladies fongiques">Maladies fongiques</button>
          <button class="category-item" data-category="Manifestations cutanées de l’infection VIH">Manifestations cutanées de l’infection VIH</button>
          <button class="category-item" data-category="Papillomavirus humains">Papillomavirus humains</button>
          <button class="category-item" data-category="Herpèsvirus humains">Herpèsvirus humains</button>
          <button class="category-item" data-category="Autres maladies virales">Autres maladies virales</button>
          <button class="category-item" data-category="Infections sexuellement transmissibles">Infections sexuellement transmissibles</button>
          <button class="category-item" data-category="Protozoaires et vers">Protozoaires et vers</button>
          <button class="category-item" data-category="Infestations">Infestations</button>
          <button class="category-item" data-category="Morsures et piqûres">Morsures et piqûres</button>

          <button class="category-item" data-category="Photodermatoses">Photodermatoses</button>
          <button class="category-item" data-category="Atteintes cutanées liées à l'environnement et au sport">Atteintes cutanées liées à l'environnement et au sport</button>
          <button class="category-item" data-category="Signes cutanés des toxicomanies, maltraitances">Signes cutanés des toxicomanies, maltraitances</button>

          <button class="category-item" data-category="Histiocytoses">Histiocytoses</button>
          <button class="category-item" data-category="Xanthomes">Xanthomes</button>
          <button class="category-item" data-category="Affections granulomateuses non infectieuses">Affections granulomateuses non infectieuses</button>
          <button class="category-item" data-category="Affections perforantes">Affections perforantes</button>
          <button class="category-item" data-category="Anomalies héréditaires du tissu conjonctif">Anomalies héréditaires du tissu conjonctif</button>
          <button class="category-item" data-category="Hypertrophies dermiques">Hypertrophies dermiques</button>
          <button class="category-item" data-category="Atrophies du tissu conjonctif">Atrophies du tissu conjonctif</button>
          <button class="category-item" data-category="Panniculites">Panniculites</button>
          <button class="category-item" data-category="Lipodystrophies">Lipodystrophies</button>

          <button class="category-item" data-category="Hémangiomes infantiles et malformations vasculaires">Hémangiomes infantiles et malformations vasculaires</button>
          <button class="category-item" data-category="Ulcères">Ulcères</button>
          <button class="category-item" data-category="Autres affections vasculaires">Autres affections vasculaires</button>

          <button class="category-item" data-category="Kératose actinique, CBC et CE">Kératose actinique, CBC et CE</button>
          <button class="category-item" data-category="Tumeurs et proliférations épithéliales bénignes">Tumeurs et proliférations épithéliales bénignes</button>
          <button class="category-item" data-category="Kystes">Kystes</button>
          <button class="category-item" data-category="Tumeurs annexielles">Tumeurs annexielles</button>
          <button class="category-item" data-category="Néoplasmes mélanocytaires bénins">Néoplasmes mélanocytaires bénins</button>
          <button class="category-item" data-category="Mélanome cutané">Mélanome cutané</button>
          <button class="category-item" data-category="Tumeurs vasculaires et proliférations réactionnelles">Tumeurs vasculaires et proliférations réactionnelles</button>
          <button class="category-item" data-category="Tumeurs fréquentes des tissus mous/ Proliférations">Tumeurs fréquentes des tissus mous/ Proliférations</button>
          <button class="category-item" data-category="Mastocytose">Mastocytose</button>

          <button class="category-item" data-category="Lymphomes cutanés à cellules B">Lymphomes cutanés à cellules B</button>
          <button class="category-item" data-category="Lymphomes cutanés à cellules T">Lymphomes cutanés à cellules T</button>
          <button class="category-item" data-category="Autres maladies lymphoprolifératives et myéloprolifératives">Autres maladies lymphoprolifératives et myéloprolifératives</button>
          <button class="category-item" data-category="Métastases cutanées">Métastases cutanées</button>
        </div>
      </aside>

      <!-- Partie droite : titre + recherche + cartes -->
      <main class="main">
        <!-- Titre + recherche -->
        <div class="top-bar">
          <h1 class="title">
            Flashcards Bolognia
            <span class="subtitle-name">– Myriam ZERROUDI</span>
          </h1>
          <div class="header-search">
            <input id="searchInput" type="text" placeholder="Rechercher un mot..." />
            <button id="searchBtn">Chercher</button>
          </div>
        </div>

        <!-- Mode révision -->
        <section id="reviewMode">
          <div class="review-layout">
            <div class="review-left">
              <div id="card" class="card"></div>
            </div>
            <div class="controls-column">
              <button id="prevBtn">Précédente</button>
              <button id="flipBtn">Retourner Q/R</button>
              <button id="knowBtn" class="btn-know">Je sais ✅</button>
              <button id="errorBtn" class="btn-error">À revoir ❌</button>
            </div>
          </div>
          <div id="info" class="info"></div>
        </section>

        <!-- Mode recherche -->
        <section id="searchMode" class="search-mode" style="display:none;">
          <div class="search-mode-header">
            <h2>Résultats de recherche</h2>
            <p class="search-query-label">Mot(s) recherché(s) : <span id="searchQueryLabel"></span></p>
            <button id="exitSearchBtn">Retour au mode révision</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // =========================
    // Verrou d'accès (code 1234)
    // =========================
    const ACCESS_KEY = "bologniaAccess_v1";
    const CORRECT_CODE = "1234";

    const lockScreenEl = document.getElementById("lockScreen");
    const appEl = document.getElementById("app");
    const codeInput = document.getElementById("codeInput");
    const codeBtn = document.getElementById("codeBtn");
    const codeError = document.getElementById("codeError");

    function grantAccess() {
      lockScreenEl.style.display = "none";
      appEl.style.display = "block";
      try { localStorage.setItem(ACCESS_KEY, "ok"); } catch (e) {}
    }
    function showLock() {
      lockScreenEl.style.display = "flex";
      appEl.style.display = "none";
      if (codeInput) setTimeout(() => codeInput.focus(), 50);
    }
    function checkCodeAndEnter() {
      const val = (codeInput.value || "").trim();
      if (val === CORRECT_CODE) { codeError.style.display = "none"; grantAccess(); }
      else { codeError.style.display = "block"; }
    }
    codeBtn.addEventListener("click", checkCodeAndEnter);
    codeInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); checkCodeAndEnter(); }});

    try {
      if (localStorage.getItem(ACCESS_KEY) === "ok") grantAccess(); else showLock();
    } catch (e) { showLock(); }

    // =========================
    // Données des cartes (LOCAL de secours)
    // =========================
    const LOCAL_CARDS = [
      /* --- tes cartes locales de démo (inchangées) --- */
      /* ... (je conserve tout ton bloc local existant) ... */
    ];

    // Variable globale utilisée partout dans l’app
    let allCards = [...LOCAL_CARDS];

    // =========================
    // Sauvegarde locale des erreurs
    // =========================
    const STORAGE_KEY = "bologniaErreurs_v1";
    let erreurIds = [];
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) erreurIds = parsed;
      }
    } catch (e) { erreurIds = []; }
    function saveErreurs() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(erreurIds)); } catch (e) {}
    }

    // =========================
    // Chargement DEPUIS L'ADMIN (data/cards.json) + fallback
    // =========================
    // L'admin écrit /data/cards.json (même domaine).
    // Format accepté:
    //   - { "cards": [ { category, front, back, image, caption } ] }
    //   - ou directement: [ { category, front, back, image, caption } ]
    const DATA_URL = "data/cards.json";

    function normalizeImagePath(p) {
      if (!p) return "";
      const s = String(p).trim();
      if (s.startsWith("http://") || s.startsWith("https://") || s.startsWith("/") || s.startsWith("./")) return s;
      // Si l'admin a déjà mis 'images/xxx.png', on ne touche pas.
      if (s.includes("/")) return s;
      // Sinon, on suppose un simple nom de fichier et on préfixe par 'images/'
      return "images/" + s;
    }

    function dedupeCards(cards) {
      const seen = new Set();
      const res = [];
      for (const c of cards) {
        const key = (c.category||"")+"||"+(c.front||"")+"||"+(c.image||"");
        if (!seen.has(key)) { seen.add(key); res.push(c); }
      }
      return res;
    }

    async function loadCards() {
      const cardEl = document.getElementById("card");
      if (cardEl) cardEl.innerHTML = "<div>Chargement des cartes…</div>";

      try {
        const res = await fetch(`${DATA_URL}?ts=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        // Accepte "json.cards" OU un tableau nu
        const list = Array.isArray(json) ? json : (Array.isArray(json.cards) ? json.cards : []);
        const remote = list.map(c => ({
          category: c.category || "Sans catégorie",
          front: (c.front || "").trim(),
          back: (c.back || "").trim(),
          image: normalizeImagePath(c.image || ""),
          caption: c.caption || ""
        }));

        // Si l'admin a fourni des cartes, on les utilise.
        // Sinon, fallback sur les LOCAL_CARDS.
        allCards = dedupeCards(remote.length ? remote : [...LOCAL_CARDS]);
      } catch (e) {
        console.warn("Impossible de charger data/cards.json, on garde les cartes locales.", e);
        allCards = dedupeCards([...LOCAL_CARDS]);
      }

      applyCategory("Aléatoire");
    }

    // =========================
    // État courant + refs DOM
    // =========================
    let currentCategory = "Aléatoire";
    let filteredCards = [];
    let currentIndex = 0;
    let isFront = true;

    const cardDiv = document.getElementById("card");
    const infoEl = document.getElementById("info");
    const prevBtn = document.getElementById("prevBtn");
    const flipBtn = document.getElementById("flipBtn");
    const knowBtn = document.getElementById("knowBtn");
    const errorBtn = document.getElementById("errorBtn");
    const categoryButtons = document.querySelectorAll(".category-item");

    const reviewModeEl = document.getElementById("reviewMode");
    const searchModeEl = document.getElementById("searchMode");
    const searchResultsEl = document.getElementById("searchResults");
    const searchQueryLabel = document.getElementById("searchQueryLabel");
    const exitSearchBtn = document.getElementById("exitSearchBtn");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function buildErrorsCards() {
      return erreurIds.map(idx => allCards[idx]).filter(Boolean);
    }

    function enterSearchMode() { reviewModeEl.style.display = "none"; searchModeEl.style.display = "block"; }
    function exitSearchMode() { searchModeEl.style.display = "none"; reviewModeEl.style.display = "block"; }

    function applyCategory(categoryName) {
      currentCategory = categoryName;

      if (categoryName === "Aléatoire") {
        filteredCards = shuffleArray(allCards);
      } else if (categoryName === "Erreurs") {
        filteredCards = buildErrorsCards();
      } else {
        filteredCards = allCards.filter(card => card.category === categoryName);
      }

      currentIndex = 0;
      isFront = true;
      renderCard();
    }

    function renderCard() {
      if (!filteredCards || filteredCards.length === 0) {
        cardDiv.innerHTML = "<div>Aucune carte pour cette catégorie pour l’instant.</div>";
        infoEl.textContent = "";
        prevBtn.disabled = true;
        flipBtn.disabled = true;
        knowBtn.disabled = true;
        errorBtn.disabled = true;
        errorBtn.classList.remove("active-error");
        return;
      }

      const current = filteredCards[currentIndex];
      const mainText = isFront ? (current.front || "") : (current.back || "");
      let html = "";

      if (mainText) html += `<div class="card-text">${mainText}</div>`;
      if (current.caption && !isFront) html += `<p class="caption">${current.caption}</p>`;
      if (current.image) html += `<img src="${current.image}" alt="Image de la carte">`;
      if (!html) html = "<div>Aucun contenu pour cette carte.</div>";

      cardDiv.innerHTML = html;

      infoEl.textContent = `Catégorie : ${currentCategory} — Carte ${currentIndex + 1} / ${filteredCards.length}`;

      prevBtn.disabled = currentIndex === 0;
      flipBtn.disabled = false;
      knowBtn.disabled = false;
      errorBtn.disabled = false;

      const globalIndex = allCards.indexOf(current);
      const isError = globalIndex !== -1 && erreurIds.includes(globalIndex);
      errorBtn.classList.toggle("active-error", isError);
    }

    function markErrorForCurrent() {
      if (!filteredCards.length) return;
      const current = filteredCards[currentIndex];
      const idx = allCards.indexOf(current);
      if (idx === -1) return;
      if (!erreurIds.includes(idx)) { erreurIds.push(idx); saveErreurs(); }
    }

    function unmarkErrorForCurrent() {
      if (!filteredCards.length) return;
      const current = filteredCards[currentIndex];
      const idx = allCards.indexOf(current);
      if (idx === -1) return;
      const pos = erreurIds.indexOf(idx);
      if (pos !== -1) { erreurIds.splice(pos, 1); saveErreurs(); }
    }

    function goNextStandard() {
      if (currentIndex < filteredCards.length - 1) currentIndex++;
      isFront = true;
      renderCard();
    }

    function flashCard(color) {
      cardDiv.style.backgroundColor = color;
      setTimeout(() => { cardDiv.style.backgroundColor = "white"; }, 200);
    }

    // ============== Recherche ==============
    function performSearch() {
      const q = (searchInput.value || "").trim().toLowerCase();
      if (!q) return;

      const words = q.split(/\s+/).filter(Boolean);

      const results = allCards
        .map((card, index) => ({ card, index }))
        .filter(({ card }) => {
          const text = (
            (card.front || "") + " " +
            (card.back || "") + " " +
            (card.caption || "") + " " +
            (card.category || "")
          ).toLowerCase();
          return words.every(w => text.includes(w));
        });

      renderSearchResults(q, results);
      enterSearchMode();
    }

    function renderSearchResults(query, results) {
      searchQueryLabel.textContent = query;

      if (!results.length) {
        searchResultsEl.innerHTML = "<p>Aucune carte ne contient ce(s) mot(s).</p>";
        return;
      }

      let html = "";
      results.forEach(({ card, index }, i) => {
        html += `
          <article class="search-card">
            <div class="search-card-header">
              <span class="search-card-index">#${i + 1}</span>
              <span class="search-card-category">${card.category || "Sans catégorie"}</span>
            </div>
            ${card.image ? `<img src="${card.image}" alt="Image de la carte">` : ""}
            <div class="search-card-front"><strong>Question :</strong> ${card.front || ""}</div>
            <div class="search-card-back"><strong>Réponse :</strong> ${card.back || ""}</div>
            ${card.caption ? `<div class="search-card-caption"><strong>Légende :</strong> ${card.caption}</div>` : ""}
            <button class="search-card-jump" data-index="${index}">Réviser cette carte</button>
          </article>
        `;
      });

      searchResultsEl.innerHTML = html;
    }

    function jumpToCard(globalIndex) {
      const card = allCards[globalIndex];
      if (!card) return;

      const targetCategory = card.category || "Aléatoire";

      categoryButtons.forEach(b => { b.classList.toggle("active", b.dataset.category === targetCategory); });

      applyCategory(targetCategory);

      const idxInFiltered = filteredCards.findIndex(c => c === card);
      if (idxInFiltered !== -1) {
        currentIndex = idxInFiltered;
        isFront = true;
        renderCard();
      }

      exitSearchMode();
    }

    // =========================
    // Événements
    // =========================
    const cardContainerEl = document.getElementById("card"); // pour le click flip
    cardContainerEl.addEventListener("click", () => { if (!filteredCards.length) return; isFront = !isFront; renderCard(); });
    flipBtn.addEventListener("click", () => { if (!filteredCards.length) return; isFront = !isFront; renderCard(); });

    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) { currentIndex--; isFront = true; renderCard(); }
    });

    // ❌ À revoir
    errorBtn.addEventListener("click", () => {
      if (!filteredCards.length) return;
      flashCard("#fee2e2");
      if (currentCategory !== "Erreurs") { markErrorForCurrent(); goNextStandard(); }
      else { goNextStandard(); }
    });

    // ✅ Je sais
    knowBtn.addEventListener("click", () => {
      if (!filteredCards.length) return;
      flashCard("#dcfce7");

      if (currentCategory === "Erreurs") {
        const previousIndex = currentIndex;
        unmarkErrorForCurrent();
        filteredCards = buildErrorsCards();

        if (filteredCards.length === 0) { renderCard(); return; }

        currentIndex = Math.min(previousIndex, filteredCards.length - 1);
        isFront = true; renderCard();
      } else {
        unmarkErrorForCurrent();
        goNextStandard();
      }
    });

    document.querySelectorAll(".category-item").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".category-item").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const cat = btn.dataset.category;
        exitSearchMode();
        applyCategory(cat);
      });
    });

    // Recherche
    searchBtn.addEventListener("click", performSearch);
    searchInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); performSearch(); }});
    exitSearchBtn.addEventListener("click", exitSearchMode);

    searchResultsEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".search-card-jump");
      if (!btn) return;
      const idx = parseInt(btn.dataset.index, 10);
      if (!Number.isNaN(idx)) jumpToCard(idx);
    });

    // ============== Raccourcis clavier ==============
    document.addEventListener("keydown", (e) => {
      if (lockScreenEl.style.display !== "none") return; // si verrou visible
      const target = e.target;
      if (target === searchInput || target === codeInput) return;

      if (e.key === " ") {
        e.preventDefault();
        if (!filteredCards.length) return;
        isFront = !isFront; renderCard();
      } else if (e.key === "ArrowLeft") {
        if (currentIndex > 0) { currentIndex--; isFront = true; renderCard(); }
      } else if (e.key === "1") {
        e.preventDefault(); knowBtn.click();
      } else if (e.key === "2") {
        e.preventDefault(); errorBtn.click();
      }
    });

    // Initialisation : CHARGER depuis /data/cards.json (admin), sinon fallback local
    loadCards();
  </script>
</body>
</html>






